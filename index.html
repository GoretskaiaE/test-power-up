<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>HR Dashboard Power-Up</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
</head>
<body>
<script>
  /* ============================================
     HR Dashboard Power-Up — Connector
     This file runs silently in the background.
     Trello loads it in a hidden iframe.
  ============================================ */

  var BASE_URL = window.location.origin + window.location.pathname.replace('index.html', '');

  // List names (case-insensitive)
  var SOURCE_LIST = 'open jobs';
  var DEST_LIST   = 'closed jobs';

  window.TrelloPowerUp.initialize({

    // ── Board button: opens the HR Dashboard modal ──────────
    'board-buttons': function(t, options) {
      return [{
        icon: BASE_URL + 'icon.svg',
        text: 'HR Dashboard',
        callback: function(t) {
          return t.modal({
            title:      'Candidates per Job',
            url:        BASE_URL + 'dashboard.html',
            height:     520,
            fullscreen: false
          });
        }
      }];
    },

    // ── Auth status: lets Trello know if the user has authorized ──
    'authorization-status': function(t, options) {
      return t.getRestApi().then(function(restApi) {
        return restApi.isAuthorized().then(function(isAuthorized) {
          return { authorized: isAuthorized };
        });
      });
    },

    // ── Show authorization: opens the auth popup ─────────────
    'show-authorization': function(t, options) {
      return t.getRestApi().then(function(restApi) {
        return restApi.authorize({
          scope:      'read,write',
          expiration: 'never'
        });
      });
    },

    // ── Card move automation ──────────────────────────────────
    // Fires whenever any card is moved to a new list.
    // When a card moves from "Open Jobs" → "Closed Jobs":
    //   1. Grab its labels
    //   2. Delete each label from the board via REST API
    'card-move': function(t, options) {

      var destName = (options.list.name || '').trim().toLowerCase();

      // Only act when the card lands in "Closed Jobs"
      if (destName !== DEST_LIST) {
        return;
      }

      var labels = options.card.labels || [];

      // Nothing to do if the card has no labels
      if (labels.length === 0) {
        return;
      }

      return t.getRestApi()
        .then(function(restApi) {
          return restApi.isAuthorized().then(function(isAuthorized) {

            if (!isAuthorized) {
              // Can't act without auth — surface a Trello notification
              return t.alert({
                message:  'HR Dashboard: please authorize the Power-Up to remove job labels automatically.',
                duration: 8,
                display:  'warning'
              });
            }

            // Delete every label that was on the card from the board.
            // Deleting a label via REST API removes it from ALL cards and the board.
            var deletePromises = labels.map(function(label) {
              return restApi.del('/1/labels/' + label.id)
                .catch(function(err) {
                  // Log per-label errors without killing the whole batch
                  console.error('HR Dashboard: failed to delete label', label.id, err);
                });
            });

            return Promise.all(deletePromises);
          });
        })
        .catch(function(err) {
          console.error('HR Dashboard: card-move error', err);
        });
    }

  });
</script>
</body>
</html>