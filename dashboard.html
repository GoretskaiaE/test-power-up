<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HR Dashboard</title>

  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f4f5f7;
      color: #172b4d;
      padding: 20px;
      min-height: 100vh;
    }

    /* ── Header ── */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      gap: 12px;
    }
    .header-left { flex: 1; }
    .header-left h1 {
      font-size: 18px;
      font-weight: 700;
      color: #172b4d;
    }
    .header-left .subtitle {
      font-size: 12px;
      color: #6b778c;
      margin-top: 2px;
    }

    /* ── Dashboard Switcher Dropdown ── */
    .switcher-wrap { flex-shrink: 0; }
    .switcher-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-end;
    }
    .switcher {
      appearance: none;
      -webkit-appearance: none;
      background: #fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%236b778c'/%3E%3C/svg%3E") no-repeat right 10px center;
      border: 1px solid #dfe1e6;
      border-radius: 6px;
      padding: 7px 30px 7px 12px;
      font-size: 13px;
      font-weight: 600;
      color: #172b4d;
      cursor: pointer;
      box-shadow: 0 1px 2px rgba(0,0,0,0.06);
      transition: border-color 0.15s;
      min-width: 190px;
    }
    .switcher:hover { border-color: #0052cc; }
    .switcher:focus { outline: none; border-color: #0052cc; box-shadow: 0 0 0 2px rgba(0,82,204,0.2); }

    /* ── Stat Cards Row ── */
    .stats-row {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: white;
      border-radius: 8px;
      padding: 14px 18px;
      flex: 1;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .stat-card .num {
      font-size: 28px;
      font-weight: 800;
      color: #0052cc;
      line-height: 1;
    }
    .stat-card .label {
      font-size: 11px;
      color: #6b778c;
      margin-top: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* ── Chart Card ── */
    .chart-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .chart-card h2 {
      font-size: 13px;
      font-weight: 600;
      color: #6b778c;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 16px;
    }
    .chart-wrapper {
      position: relative;
      height: 260px;
    }

    /* ── Loading / Error ── */
    .state-msg {
      text-align: center;
      padding: 60px 20px;
      color: #6b778c;
      font-size: 14px;
    }
    .state-msg .icon { font-size: 32px; margin-bottom: 10px; }

    /* ── Item List (below chart) ── */
    .item-list {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .item-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
    }
    .item-name {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .color-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .item-count {
      font-weight: 700;
      color: #0052cc;
      background: #e8f0fe;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 12px;
    }
  </style>
</head>
<body>

<div id="loading" class="state-msg">
  <div class="icon">⏳</div>
  Loading data...
</div>

<div id="app" style="display:none">

  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <h1 id="dashboard-title">Recruitment Overview</h1>
      <div class="subtitle" id="board-name">Loading board...</div>
    </div>
    <div class="switcher-wrap">
      <div class="switcher-row">
        <select class="switcher" id="job-type-switcher">
          <option value="open">Open Jobs</option>
          <option value="closed">Closed Jobs</option>
          <option value="unassigned">Unassigned Candidates</option>
          <option value="all">All Job Types</option>
        </select>
        <select class="switcher" id="dashboard-switcher">
          <option value="by-job">Candidates per Job</option>
          <option value="by-stage">Candidates per Stage</option>
          <option value="by-job-and-stage">Candidates per Job and Stage</option>
          <option value="by-member-and-stage">Candidates per Member and Stage</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Stat Cards -->
  <div class="stats-row">
    <div class="stat-card">
      <div class="num" id="stat-total">—</div>
      <div class="label">Total Candidates</div>
    </div>
    <div class="stat-card">
      <div class="num" id="stat-groups">—</div>
      <div class="label" id="stat-groups-label">Groups</div>
    </div>
    <div class="stat-card">
      <div class="num" id="stat-avg">—</div>
      <div class="label">Avg per Group</div>
    </div>
  </div>

  <!-- Bar Chart -->
  <div class="chart-card">
    <h2 id="chart-title">Chart</h2>
    <div class="chart-wrapper">
      <canvas id="myChart"></canvas>
    </div>
    <div class="item-list" id="item-list"></div>
  </div>

</div>

<div id="error" class="state-msg" style="display:none">
  <div class="icon">⚠️</div>
  <div id="error-msg">Something went wrong.</div>
</div>


<script>
/* ============================================
   HR Dashboard v4
   Dashboards:
   1. Candidates per Job        — groups cards by label
   2. Candidates per Stage      — groups cards by list name
   3. Candidates per Job+Stage  — stacked bar by label × list
   4. Candidates per Member+Stage — stacked bar by member × list
   Job type filter applies to all dashboards.
============================================ */

var EXCLUDED_LISTS = ['clients', 'open jobs', 'closed jobs'];

var COLOURS = [
  '#0052cc', '#00875a', '#ff5630', '#ff8b00',
  '#6554c0', '#00b8d9', '#36b37e', '#ff7452',
  '#172b4d', '#97a0af'
];

var t = window.TrelloPowerUp.iframe();

// Holds fetched data so switcher doesn't re-fetch
var appData = null;
var chartInstance = null;

// ── Filter candidate cards by job type selection ───────────────────
// openLabelIds  = Set of label IDs found on cards in "Open Jobs" list
// closedLabelIds = Set of label IDs found on cards in "Closed Jobs" list
function filterCandidateCards(jobType) {
  var all = appData.allCandidateCards;

  if (jobType === 'all') return all;

  if (jobType === 'open') {
    return all.filter(function(card) {
      return card.labels && card.labels.some(function(l) {
        return appData.openLabelIds.has(l.id);
      });
    });
  }

  if (jobType === 'closed') {
    return all.filter(function(card) {
      return card.labels && card.labels.some(function(l) {
        return appData.closedLabelIds.has(l.id);
      });
    });
  }

  if (jobType === 'unassigned') {
    // Cards that have NO label belonging to either open or closed jobs
    var allJobLabelIds = new Set(
      Array.from(appData.openLabelIds).concat(Array.from(appData.closedLabelIds))
    );
    return all.filter(function(card) {
      if (!card.labels || card.labels.length === 0) return true;
      return !card.labels.some(function(l) { return allJobLabelIds.has(l.id); });
    });
  }

  return all;
}

function showError(msg) {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('app').style.display     = 'none';
  document.getElementById('error').style.display   = 'block';
  document.getElementById('error-msg').textContent  = msg;
}

// ── Render a dashboard view given a groups object { name: count } ──
function renderDashboard(config) {
  var groupNames  = Object.keys(config.groups);
  var groupValues = groupNames.map(function(n) { return config.groups[n]; });
  var total       = config.totalCards;
  var numGroups   = groupNames.length;
  var avg         = numGroups > 0 ? (total / numGroups).toFixed(1) : 0;

  // Stats
  document.getElementById('dashboard-title').textContent   = config.title;
  document.getElementById('chart-title').textContent       = config.chartTitle;
  document.getElementById('stat-groups-label').textContent = config.groupsLabel;
  document.getElementById('stat-total').textContent        = total;
  document.getElementById('stat-groups').textContent       = numGroups;
  document.getElementById('stat-avg').textContent          = avg;

  // Colours
  var barColours = groupNames.map(function(_, i) {
    return COLOURS[i % COLOURS.length];
  });

  // Destroy previous chart if exists
  if (chartInstance) {
    chartInstance.destroy();
    chartInstance = null;
  }

  // Draw chart
  var ctx = document.getElementById('myChart').getContext('2d');
  chartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: groupNames,
      datasets: [{
        label: 'Candidates',
        data: groupValues,
        backgroundColor: barColours.map(function(c) { return c + 'cc'; }),
        borderColor: barColours,
        borderWidth: 2,
        borderRadius: 6,
        borderSkipped: false
      }]
    },
    options: {
      responsive:          true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(ctx) {
              return ' ' + ctx.parsed.y + ' candidate' + (ctx.parsed.y !== 1 ? 's' : '');
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { stepSize: 1, precision: 0 },
          grid: { color: '#f0f0f0' }
        },
        x: { grid: { display: false } }
      }
    }
  });

  // Build list below chart
  var listEl = document.getElementById('item-list');
  listEl.innerHTML = '';
  groupNames.forEach(function(name, i) {
    var row = document.createElement('div');
    row.className = 'item-row';
    row.innerHTML =
      '<div class="item-name">' +
        '<div class="color-dot" style="background:' + barColours[i] + '"></div>' +
        '<span>' + name + '</span>' +
      '</div>' +
      '<span class="item-count">' + config.groups[name] + '</span>';
    listEl.appendChild(row);
  });

  t.sizeTo('#app').catch(function() {});
}

// ── Dashboard: Candidates per Job (grouped by label) ──────────────
function buildByJob(candidateCards) {
  var groups = {};
  candidateCards.forEach(function(card) {
    if (card.labels && card.labels.length > 0) {
      card.labels.forEach(function(label) {
        var name = label.name || ('(no name - ' + label.color + ')');
        groups[name] = (groups[name] || 0) + 1;
      });
    } else {
      groups['Unassigned'] = (groups['Unassigned'] || 0) + 1;
    }
  });
  return {
    title:       'Candidates per Job',
    chartTitle:  'Candidates per Job',
    groupsLabel: 'Open Jobs',
    totalCards:  candidateCards.length,
    groups:      groups
  };
}

// ── Dashboard: Candidates per Stage (grouped by list name) ────────
function buildByStage(candidateCards, listsMap) {
  // Pre-initialise every non-excluded list to 0 so empty lists still appear
  var groups = {};
  Object.keys(listsMap).forEach(function(id) {
    groups[listsMap[id]] = 0;
  });
  candidateCards.forEach(function(card) {
    var listName = listsMap[card.idList] || 'Unknown';
    groups[listName] = (groups[listName] || 0) + 1;
  });
  return {
    title:       'Candidates per Stage',
    chartTitle:  'Candidates per Stage',
    groupsLabel: 'Stages',
    totalCards:  candidateCards.length,
    groups:      groups
  };
}

// ── Dashboard: Candidates per Job and Stage (stacked bar) ─────────
function buildByJobAndStage(candidateCards, listsMap) {
  // Collect all job names and stage names in encounter order
  var jobNames   = [];
  var stageNames = [];
  var jobSet     = {};
  var stageSet   = {};

  // First pass: collect unique jobs and stages
  candidateCards.forEach(function(card) {
    var stageName = listsMap[card.idList] || 'Unknown';
    if (!stageSet[stageName]) { stageSet[stageName] = true; stageNames.push(stageName); }

    var labels = (card.labels && card.labels.length > 0)
      ? card.labels
      : [{ name: 'Unassigned' }];

    labels.forEach(function(label) {
      var jobName = label.name || ('(no name - ' + label.color + ')');
      if (!jobSet[jobName]) { jobSet[jobName] = true; jobNames.push(jobName); }
    });
  });

  // Also include stages that have 0 cards (from listsMap)
  Object.values(listsMap).forEach(function(stageName) {
    if (!stageSet[stageName]) { stageSet[stageName] = true; stageNames.push(stageName); }
  });

  // Build counts: counts[jobName][stageName] = n
  var counts = {};
  jobNames.forEach(function(job) {
    counts[job] = {};
    stageNames.forEach(function(stage) { counts[job][stage] = 0; });
  });

  candidateCards.forEach(function(card) {
    var stageName = listsMap[card.idList] || 'Unknown';
    var labels = (card.labels && card.labels.length > 0)
      ? card.labels
      : [{ name: 'Unassigned' }];
    labels.forEach(function(label) {
      var jobName = label.name || ('(no name - ' + label.color + ')');
      counts[jobName][stageName] = (counts[jobName][stageName] || 0) + 1;
    });
  });

  return {
    type:        'stacked',
    title:       'Candidates per Job and Stage',
    chartTitle:  'Candidates per Job and Stage',
    totalCards:  candidateCards.length,
    jobNames:    jobNames,
    stageNames:  stageNames,
    counts:      counts,
    groupsLabel: 'Jobs'
  };
}

// ── Dashboard: Candidates per Member and Stage (stacked bar) ──────
function buildByMemberAndStage(candidateCards, listsMap) {
  var memberNames = [];
  var stageNames  = [];
  var memberSet   = {};
  var stageSet    = {};

  // First pass: collect unique members and stages
  candidateCards.forEach(function(card) {
    var stageName = listsMap[card.idList] || 'Unknown';
    if (!stageSet[stageName]) { stageSet[stageName] = true; stageNames.push(stageName); }

    var members = (card.members && card.members.length > 0)
      ? card.members
      : [{ fullName: 'Unassigned' }];

    members.forEach(function(m) {
      var name = m.fullName || m.username || 'Unassigned';
      if (!memberSet[name]) { memberSet[name] = true; memberNames.push(name); }
    });
  });

  // Include all non-excluded stages even if 0 cards
  Object.values(listsMap).forEach(function(stageName) {
    if (!stageSet[stageName]) { stageSet[stageName] = true; stageNames.push(stageName); }
  });

  // Build counts matrix
  var counts = {};
  memberNames.forEach(function(member) {
    counts[member] = {};
    stageNames.forEach(function(stage) { counts[member][stage] = 0; });
  });

  candidateCards.forEach(function(card) {
    var stageName = listsMap[card.idList] || 'Unknown';
    var members = (card.members && card.members.length > 0)
      ? card.members
      : [{ fullName: 'Unassigned' }];
    members.forEach(function(m) {
      var name = m.fullName || m.username || 'Unassigned';
      counts[name][stageName] = (counts[name][stageName] || 0) + 1;
    });
  });

  return {
    type:        'stacked',
    title:       'Candidates per Member and Stage',
    chartTitle:  'Candidates per Member and Stage',
    totalCards:  candidateCards.length,
    jobNames:    memberNames,   // reuse jobNames key so renderStackedDashboard works as-is
    stageNames:  stageNames,
    counts:      counts,
    groupsLabel: 'Members'
  };
}


function renderStackedDashboard(config) {
  document.getElementById('dashboard-title').textContent   = config.title;
  document.getElementById('chart-title').textContent       = config.chartTitle;
  document.getElementById('stat-groups-label').textContent = config.groupsLabel || 'Jobs';
  document.getElementById('stat-total').textContent        = config.totalCards;
  document.getElementById('stat-groups').textContent       = config.jobNames.length;

  var totalGroups = config.jobNames.length;
  var avg = totalGroups > 0 ? (config.totalCards / totalGroups).toFixed(1) : 0;
  document.getElementById('stat-avg').textContent = avg;

  if (chartInstance) { chartInstance.destroy(); chartInstance = null; }

  // One dataset per stage
  var datasets = config.stageNames.map(function(stage, i) {
    var colour = COLOURS[i % COLOURS.length];
    return {
      label:           stage,
      data:            config.jobNames.map(function(job) { return config.counts[job][stage] || 0; }),
      backgroundColor: colour + 'cc',
      borderColor:     colour,
      borderWidth:     2,
      borderRadius:    0,
      borderSkipped:   false
    };
  });

  var ctx = document.getElementById('myChart').getContext('2d');
  chartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels:   config.jobNames,
      datasets: datasets
    },
    options: {
      responsive:          true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display:  true,
          position: 'bottom',
          labels:   { boxWidth: 12, font: { size: 11 } }
        },
        tooltip: {
          callbacks: {
            label: function(ctx) {
              return ' ' + ctx.dataset.label + ': ' + ctx.parsed.y +
                ' candidate' + (ctx.parsed.y !== 1 ? 's' : '');
            }
          }
        }
      },
      scales: {
        x: { stacked: true, grid: { display: false } },
        y: {
          stacked: true,
          beginAtZero: true,
          ticks: { stepSize: 1, precision: 0 },
          grid:  { color: '#f0f0f0' }
        }
      }
    }
  });

  // Build legend table: jobs as rows, stages as columns
  var listEl = document.getElementById('item-list');
  listEl.innerHTML = '';

  var table = document.createElement('table');
  table.style.cssText = 'width:100%;border-collapse:collapse;font-size:12px;margin-top:8px;';

  // Header row: empty corner + one column per stage
  var thead = document.createElement('thead');
  var headRow = document.createElement('tr');

  var cornerTh = document.createElement('th');
  cornerTh.style.cssText = 'text-align:left;padding:6px 8px;border-bottom:2px solid #dfe1e6;color:#6b778c;font-weight:600;white-space:nowrap;';
  cornerTh.textContent = (config.groupsLabel || 'Job') + ' / Stage';
  headRow.appendChild(cornerTh);

  config.stageNames.forEach(function(stage, i) {
    var th = document.createElement('th');
    var colour = COLOURS[i % COLOURS.length];
    th.style.cssText = 'text-align:center;padding:6px 8px;border-bottom:2px solid ' + colour + ';color:' + colour + ';font-weight:600;white-space:nowrap;';
    th.textContent = stage;
    headRow.appendChild(th);
  });

  // Total column header
  var totalTh = document.createElement('th');
  totalTh.style.cssText = 'text-align:center;padding:6px 8px;border-bottom:2px solid #172b4d;color:#172b4d;font-weight:600;';
  totalTh.textContent = 'Total';
  headRow.appendChild(totalTh);

  thead.appendChild(headRow);
  table.appendChild(thead);

  // Body rows: one per job
  var tbody = document.createElement('tbody');
  config.jobNames.forEach(function(job, rowIdx) {
    var tr = document.createElement('tr');
    tr.style.background = rowIdx % 2 === 0 ? '#f8f9fc' : '#ffffff';

    var jobTd = document.createElement('td');
    jobTd.style.cssText = 'padding:6px 8px;font-weight:600;color:#172b4d;white-space:nowrap;border-bottom:1px solid #f0f0f0;';
    jobTd.textContent = job;
    tr.appendChild(jobTd);

    var jobTotal = 0;
    config.stageNames.forEach(function(stage, i) {
      var count = config.counts[job][stage] || 0;
      jobTotal += count;
      var td = document.createElement('td');
      td.style.cssText = 'text-align:center;padding:6px 8px;border-bottom:1px solid #f0f0f0;color:' + (count > 0 ? '#172b4d' : '#c1c7d0') + ';';
      td.textContent = count > 0 ? count : '—';
      tr.appendChild(td);
    });

    // Total cell
    var totalTd = document.createElement('td');
    totalTd.style.cssText = 'text-align:center;padding:6px 8px;border-bottom:1px solid #f0f0f0;font-weight:700;color:#0052cc;background:#e8f0fe;';
    totalTd.textContent = jobTotal;
    tr.appendChild(totalTd);

    tbody.appendChild(tr);
  });

  // Footer row: totals per stage
  var footRow = document.createElement('tr');
  footRow.style.background = '#f0f0f0';

  var footLabelTd = document.createElement('td');
  footLabelTd.style.cssText = 'padding:6px 8px;font-weight:700;color:#172b4d;border-top:2px solid #dfe1e6;';
  footLabelTd.textContent = 'Total';
  footRow.appendChild(footLabelTd);

  var grandTotal = 0;
  config.stageNames.forEach(function(stage) {
    var stageTotal = config.jobNames.reduce(function(sum, job) {
      return sum + (config.counts[job][stage] || 0);
    }, 0);
    grandTotal += stageTotal;
    var td = document.createElement('td');
    td.style.cssText = 'text-align:center;padding:6px 8px;font-weight:700;color:#172b4d;border-top:2px solid #dfe1e6;';
    td.textContent = stageTotal;
    footRow.appendChild(td);
  });

  var grandTd = document.createElement('td');
  grandTd.style.cssText = 'text-align:center;padding:6px 8px;font-weight:800;color:#0052cc;background:#e8f0fe;border-top:2px solid #dfe1e6;';
  grandTd.textContent = grandTotal;
  footRow.appendChild(grandTd);

  tbody.appendChild(footRow);
  table.appendChild(tbody);
  listEl.appendChild(table);

  t.sizeTo('#app').catch(function() {});
}


function switchDashboard(view, jobType) {
  if (!appData) return;
  jobType = jobType || document.getElementById('job-type-switcher').value;
  var cards = filterCandidateCards(jobType);
  if (view === 'by-job-and-stage') {
    renderStackedDashboard(buildByJobAndStage(cards, appData.listsMap));
  } else if (view === 'by-member-and-stage') {
    renderStackedDashboard(buildByMemberAndStage(cards, appData.listsMap));
  } else if (view === 'by-stage') {
    renderDashboard(buildByStage(cards, appData.listsMap));
  } else {
    renderDashboard(buildByJob(cards));
  }
}

document.getElementById('dashboard-switcher').addEventListener('change', function() {
  switchDashboard(this.value);
});

document.getElementById('job-type-switcher').addEventListener('change', function() {
  switchDashboard(document.getElementById('dashboard-switcher').value, this.value);
});

// ── Main ───────────────────────────────────────────────────────────
t.render(function() {
  Promise.all([
    t.board('name'),
    t.lists('id', 'name'),
    t.cards('id', 'name', 'labels', 'idList', 'members')
  ])
  .then(function(results) {
    var board    = results[0];
    var lists    = results[1];
    var allCards = results[2];

    document.getElementById('board-name').textContent = board.name;

    // Build excluded list ID set
    var excludedIds = new Set(
      lists
        .filter(function(l) {
          return EXCLUDED_LISTS.indexOf(l.name.trim().toLowerCase()) !== -1;
        })
        .map(function(l) { return l.id; })
    );

    // Find Open Jobs and Closed Jobs list IDs specifically
    var openJobsList   = lists.find(function(l) { return l.name.trim().toLowerCase() === 'open jobs'; });
    var closedJobsList = lists.find(function(l) { return l.name.trim().toLowerCase() === 'closed jobs'; });

    // Collect label IDs from cards in Open Jobs list
    var openLabelIds = new Set();
    if (openJobsList) {
      allCards
        .filter(function(c) { return c.idList === openJobsList.id; })
        .forEach(function(c) {
          (c.labels || []).forEach(function(l) { openLabelIds.add(l.id); });
        });
    }

    // Collect label IDs from cards in Closed Jobs list
    var closedLabelIds = new Set();
    if (closedJobsList) {
      allCards
        .filter(function(c) { return c.idList === closedJobsList.id; })
        .forEach(function(c) {
          (c.labels || []).forEach(function(l) { closedLabelIds.add(l.id); });
        });
    }

    // Build listsMap: id → name (for all non-excluded lists)
    var listsMap = {};
    lists.forEach(function(l) {
      if (!excludedIds.has(l.id)) {
        listsMap[l.id] = l.name;
      }
    });

    // All candidate cards (no job-type filter yet)
    var allCandidateCards = allCards.filter(function(c) {
      return !excludedIds.has(c.idList);
    });

    // Store for switcher re-use
    appData = {
      allCandidateCards: allCandidateCards,
      listsMap:          listsMap,
      openLabelIds:      openLabelIds,
      closedLabelIds:    closedLabelIds
    };

    // Render default view: Open Jobs filter, Candidates per Job
    renderDashboard(buildByJob(filterCandidateCards('open')));

    document.getElementById('loading').style.display = 'none';
    document.getElementById('app').style.display     = 'block';
    t.sizeTo('#app').catch(function() {});
  })
  .catch(function(err) {
    showError('Error loading board data: ' + err.message);
  });
});
</script>

</body>
</html>